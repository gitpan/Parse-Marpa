#!/usr/bin/env perl
require 5.009005;
use feature ":5.10";

use Carp;
use Getopt::Long;
use Parse::Marpa;
use English;
use Fatal qw(open close);

my $command = shift;
my $grammar_file;
my %options;

given ($command) {
    when ('compile') {
        croak unless GetOptions("option=s" => \%options);
	do_compile();
    }
    when ('parse') {
        croak unless GetOptions(
	    "grammar=s" => \$grammar_file,
	    "compiled_grammar=s" => \$compiled_grammar_file,
	    "option=s" => \%options
	);
	do_parse();
    }
    default {
        croak("Unimplemented marpa command: $command");
    }
}

sub do_compile {
    my $grammar_source; { local($RS) = undef; $grammar_source = <STDIN>; }

    my $grammar = new Parse::Marpa(
	 source => \$grammar_source,
	 %options
    );

    $grammar->precompute();
    my $compiled_grammar = $grammar->compile();
    print $$compiled_grammar;
}

sub do_parse {

    my $grammar;
    if (defined $compiled_grammar_file) {
	open(GRAMMAR, "<", $compiled_grammar_file);
	my $compiled_grammar; { local($RS) = undef; $compiled_grammar = <GRAMMAR>; }
	$grammar = Parse::Marpa::decompile();
    }
    elsif (defined $grammar_file) {
	open(GRAMMAR, "<", $grammar_file);
	my $grammar_source; { local($RS) = undef; $grammar_source = <GRAMMAR>; }
	eval {
	    $grammar = new Parse::Marpa(
		source => \$grammar_source,
		(%options)
	    );
	};
	if ($@) {
	    die("Parse of $grammar_file failed:\n", $@);
	}
	%options = ();
    }
    else {
        croak("No grammar specified");
    }

    my $parse = new Parse::Marpa::Parse(
        grammar => $grammar,
	(%options)
    );
    my $text; { local($RS) = undef; $text = <STDIN>; }

    if ((my $fail_location = $parse->text(\$text)) >= 0) {
        print STDERR Parse::Marpa::show_location("Parse failed", \$text, $fail_location);
	exit 1;
    }

    if (!$parse->initial()) {
        croak("No parse")
    }

    my $value = $parse->value();
    if (defined $value) {
	say $$value;
    } else {
	say 'Marpa returned a "Marpa No Value"';
    }

}
